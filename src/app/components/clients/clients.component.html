<div class="clients-container">
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Loading...</p>
    </div>
  </div>

  <!-- Error Alert -->
  <div class="alert alert-error" *ngIf="error" (click)="clearError()">
    <i class="fas fa-exclamation-triangle"></i>
    <span>{{ error }}</span>
    <button class="btn-close-alert">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">
          <i class="fas fa-users"></i>
          Contact Management
        </h1>
        <p class="page-subtitle">Manage your clients, prospects, and external policies</p>
      </div>
      <div class="header-right">
        <button class="btn btn-secondary" (click)="refreshData()" [disabled]="loading" title="Refresh Data">
          <i class="fas fa-sync-alt" [class.fa-spin]="loading"></i>
          Refresh
        </button>
        <button class="btn btn-primary" (click)="openAddModal()">
          <i class="fas fa-plus"></i>
          Add New {{ activeTab === 'clients' ? 'Client' : 'Prospect' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'clients'"
      (click)="switchTab('clients')">
      <i class="fas fa-user-check"></i>
      <span>Clients</span>
      <span class="tab-count">{{ getTabCount('clients') }}</span>
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'prospects'"
      (click)="switchTab('prospects')">
      <i class="fas fa-user-plus"></i>
      <span>Prospects</span>
      <span class="tab-count">{{ getTabCount('prospects') }}</span>
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'prospects_with_policies'"
      (click)="switchTab('prospects_with_policies')">
      <i class="fas fa-shield-alt"></i>
      <span>Prospects with Policies</span>
      <span class="tab-count">{{ getTabCount('prospects_with_policies') }}</span>
    </button>
  </div>

  <!-- Tab Statistics -->
  <div class="tab-stats" [ngSwitch]="activeTab">
    <!-- Clients Stats -->
    <div *ngSwitchCase="'clients'" class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon clients">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.clients.total }}</h3>
          <p>Total Clients</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon policies">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.clients.activePolicies }}</h3>
          <p>Active Policies</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon expiring">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.clients.expiringPolicies }}</h3>
          <p>Expiring Soon</p>
        </div>
      </div>
      <div class="stat-card" *ngIf="birthdays.length > 0">
        <div class="stat-icon birthdays">
          <i class="fas fa-birthday-cake"></i>
        </div>
        <div class="stat-content">
          <h3>{{ birthdays.length }}</h3>
          <p>Birthdays Today</p>
        </div>
      </div>
    </div>

    <!-- Prospects Stats -->
    <div *ngSwitchCase="'prospects'" class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon prospects">
          <i class="fas fa-user-plus"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.prospects.total }}</h3>
          <p>Total Prospects</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon new">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.prospects.newThisWeek }}</h3>
          <p>Added This Week</p>
        </div>
      </div>
    </div>

    <!-- Prospects with Policies Stats -->
    <div *ngSwitchCase="'prospects_with_policies'" class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon prospects-policies">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.prospectsWithPolicies.total }}</h3>
          <p>With Policies</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon urgent">
          <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.prospectsWithPolicies.expiringIn7Days }}</h3>
          <p>Expiring in 7 Days</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon warning">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.prospectsWithPolicies.expiringIn30Days }}</h3>
          <p>Expiring in 30 Days</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon expired">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-content">
          <h3>{{ tabStatistics.prospectsWithPolicies.expired }}</h3>
          <p>Already Expired</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <div class="search-bar">
      <div class="search-input-group">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          placeholder="Search by name, phone, or email..." 
          [(ngModel)]="searchTerm" 
          (input)="onSearch()"
          class="search-input"
          [disabled]="loading">
      </div>
    </div>
  </div>

  <!-- Contacts Grid -->
  <div class="contacts-grid" *ngIf="filteredContacts.length > 0 && !loading">
    <div class="contact-card" *ngFor="let contact of filteredContacts; trackBy: trackByContactId">
      <div class="contact-header">
        <div class="contact-avatar">
          <span>{{ contact.firstName[0] }}{{ contact.surname[0] || contact.lastName[0] }}</span>
        </div>
        <div class="contact-info">
          <h3 class="contact-name">{{ getDisplayName(contact) }}</h3>
          <div class="contact-status">
            <span class="status-badge" [ngClass]="contact.type">
              {{ contact.type === 'client' ? 'Client' : 'Prospect' }}
            </span>
            <span class="insurance-type" *ngIf="contact.insuranceType">{{ contact.insuranceType }}</span>
            <span class="has-policies" *ngIf="contact.hasExternalPolicies">
              <i class="fas fa-shield-alt"></i> Has Policies
            </span>
          </div>
        </div>
        <div class="contact-actions">
          <button class="btn-icon" (click)="openViewModal(contact)" title="View Details">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn-icon" (click)="openEditModal(contact)" title="Edit">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon" *ngIf="activeTab === 'prospects_with_policies'" 
                  (click)="openAddPolicyModal(contact)" title="Add Policy">
            <i class="fas fa-plus"></i>
          </button>
          <button class="btn-icon delete" (click)="deleteContact(contact)" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      
      <div class="contact-details">
        <div class="detail-row" *ngIf="contact.phoneNumber">
          <i class="fas fa-phone"></i>
          <span>{{ contact.phoneNumber }}</span>
        </div>
        <div class="detail-row" *ngIf="contact.email">
          <i class="fas fa-envelope"></i>
          <span>{{ contact.email }}</span>
        </div>
        <div class="detail-row" *ngIf="contact.address">
          <i class="fas fa-map-marker-alt"></i>
          <span>{{ contact.address }}</span>
        </div>
      </div>

      <!-- Policy Information for Prospects with Policies -->
      <div class="contact-policies" *ngIf="contact.policies && contact.policies.length > 0">
        <h4>External Policies</h4>
        <div class="policy-list">
          <div class="policy-item" *ngFor="let policy of contact.policies">
            <div class="policy-header">
              <span class="policy-company">{{ policy.companyName }}</span>
              <span class="policy-status" [ngClass]="policy.status.toLowerCase()">
                {{ policy.status }}
              </span>
            </div>
            <div class="policy-details">
              <span class="policy-type">{{ policy.type }}</span>
              <span class="policy-expiry" *ngIf="policy.expiryDate">
                Expires: {{ formatDate(policy.expiryDate) }}
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="contact-footer">
        <div class="footer-actions">
          <button class="btn btn-sm btn-secondary" 
                  *ngIf="contact.type === 'prospect'" 
                  (click)="convertProspectToClient(contact)">
            <i class="fas fa-user-check"></i>
            Convert to Client
          </button>
          <button class="btn btn-sm btn-outline" 
                  *ngIf="activeTab === 'prospects' && !contact.hasExternalPolicies"
                  (click)="openAddPolicyModal(contact)">
            <i class="fas fa-shield-alt"></i>
            Add Policy
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State for Grid -->
  <div class="loading-grid" *ngIf="loading && filteredContacts.length === 0">
    <div class="skeleton-card" *ngFor="let item of [1,2,3,4,5,6]">
      <div class="skeleton-header">
        <div class="skeleton-avatar"></div>
        <div class="skeleton-info">
          <div class="skeleton-line skeleton-name"></div>
          <div class="skeleton-line skeleton-status"></div>
        </div>
      </div>
      <div class="skeleton-details">
        <div class="skeleton-line" *ngFor="let line of [1,2,3]"></div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="filteredContacts.length === 0 && !loading">
    <div class="empty-icon">
      <i class="fas" [ngClass]="{
        'fa-users': activeTab === 'clients',
        'fa-user-plus': activeTab === 'prospects',
        'fa-shield-alt': activeTab === 'prospects_with_policies'
      }"></i>
    </div>
    <h3>No {{ activeTab === 'clients' ? 'clients' : activeTab === 'prospects' ? 'prospects' : 'prospects with policies' }} found</h3>
    <p *ngIf="searchTerm">Try adjusting your search criteria</p>
    <p *ngIf="!searchTerm">Start by adding your first {{ activeTab === 'clients' ? 'client' : 'prospect' }}</p>
    <button class="btn btn-primary" (click)="openAddModal()">
      <i class="fas fa-plus"></i>
      Add First {{ activeTab === 'clients' ? 'Client' : 'Prospect' }}
    </button>
  </div>
</div>

<!-- Add/Edit Contact Modal -->
<div class="modal-overlay" *ngIf="showAddModal || showEditModal" (click)="showAddModal ? closeAddModal() : closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ showAddModal ? 'Add New' : 'Edit' }} {{ activeTab === 'clients' ? 'Client' : 'Prospect' }}</h2>
      <button class="btn-close" (click)="showAddModal ? closeAddModal() : closeEditModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="contactForm" (ngSubmit)="onSubmit()" class="contact-form">
      <!-- Form Error Display -->
      <div class="form-error" *ngIf="error">
        <i class="fas fa-exclamation-circle"></i>
        <span>{{ error }}</span>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="firstName">First Name *</label>
          <input type="text" id="firstName" formControlName="firstName" class="form-control" [disabled]="loading">
          <div class="error-message" *ngIf="contactForm.get('firstName')?.invalid && contactForm.get('firstName')?.touched">
            First name is required
          </div>
        </div>
        
        <div class="form-group">
          <label for="surname">Surname *</label>
          <input type="text" id="surname" formControlName="surname" class="form-control" [disabled]="loading">
          <div class="error-message" *ngIf="contactForm.get('surname')?.invalid && contactForm.get('surname')?.touched">
            Surname is required
          </div>
        </div>
        
        <div class="form-group">
          <label for="lastName">Last Name *</label>
          <input type="text" id="lastName" formControlName="lastName" class="form-control" [disabled]="loading">
          <div class="error-message" *ngIf="contactForm.get('lastName')?.invalid && contactForm.get('lastName')?.touched">
            Last name is required
          </div>
        </div>
        
        <div class="form-group">
          <label for="phoneNumber">Phone Number *</label>
          <input type="tel" id="phoneNumber" formControlName="phoneNumber" class="form-control" placeholder="07xxxxxxxx" [disabled]="loading">
          <div class="error-message" *ngIf="contactForm.get('phoneNumber')?.invalid && contactForm.get('phoneNumber')?.touched">
            Valid phone number is required
          </div>
        </div>
        
        <div class="form-group">
          <label for="email">Email Address *</label>
          <input type="email" id="email" formControlName="email" class="form-control" [disabled]="loading">
          <div class="error-message" *ngIf="contactForm.get('email')?.invalid && contactForm.get('email')?.touched">
            Valid email address is required
          </div>
        </div>

        <!-- Client-specific fields -->
        <div class="form-group" *ngIf="activeTab === 'clients' || contactForm.get('isClient')?.value">
          <label for="nationalId">National ID {{ activeTab === 'clients' ? '*' : '' }}</label>
          <input type="text" id="nationalId" formControlName="nationalId" class="form-control" [disabled]="loading">
          <div class="error-message" *ngIf="contactForm.get('nationalId')?.invalid && contactForm.get('nationalId')?.touched">
            National ID is required for clients
          </div>
        </div>
        
        <div class="form-group" *ngIf="activeTab === 'clients' || contactForm.get('isClient')?.value">
          <label for="dateOfBirth">Date of Birth {{ activeTab === 'clients' ? '*' : '' }}</label>
          <input type="date" id="dateOfBirth" formControlName="dateOfBirth" class="form-control" [disabled]="loading">
          <div class="error-message" *ngIf="contactForm.get('dateOfBirth')?.invalid && contactForm.get('dateOfBirth')?.touched">
            Date of birth is required for clients
          </div>
        </div>
        
        <div class="form-group" *ngIf="activeTab === 'clients' || contactForm.get('isClient')?.value">
          <label for="insuranceType">Insurance Type {{ activeTab === 'clients' ? '*' : '' }}</label>
          <select id="insuranceType" formControlName="insuranceType" class="form-control" [disabled]="loading">
            <option value="">Select Insurance Type</option>
            <option *ngFor="let type of insuranceTypes" [value]="type">{{ type }}</option>
          </select>
          <div class="error-message" *ngIf="contactForm.get('insuranceType')?.invalid && contactForm.get('insuranceType')?.touched">
            Please select an insurance type for clients
          </div>
        </div>
      </div>
      
      <div class="form-group full-width" *ngIf="activeTab === 'clients' || contactForm.get('isClient')?.value">
        <label for="address">Address {{ activeTab === 'clients' ? '*' : '' }}</label>
        <textarea id="address" formControlName="address" class="form-control" rows="2" [disabled]="loading"></textarea>
        <div class="error-message" *ngIf="contactForm.get('address')?.invalid && contactForm.get('address')?.touched">
          Address is required for clients
        </div>
      </div>
      
      <div class="form-group full-width">
        <label for="notes">Notes</label>
        <textarea id="notes" formControlName="notes" class="form-control" rows="3" placeholder="Additional notes..." [disabled]="loading"></textarea>
      </div>
      
      <div class="form-group checkbox-group" *ngIf="activeTab !== 'clients'">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="isClient" [disabled]="loading">
          <span class="checkmark"></span>
          Mark as Client (instead of Prospect)
        </label>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="showAddModal ? closeAddModal() : closeEditModal()" [disabled]="loading">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="contactForm.invalid || loading">
          <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
          <i class="fas fa-check" *ngIf="!loading"></i>
          {{ showAddModal ? 'Add' : 'Update' }} {{ activeTab === 'clients' ? 'Client' : 'Contact' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Add Policy Modal -->
<div class="modal-overlay" *ngIf="showAddPolicyModal" (click)="closeAddPolicyModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Add External Policy</h2>
      <button class="btn-close" (click)="closeAddPolicyModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form [formGroup]="policyForm" (ngSubmit)="onAddPolicy()" class="policy-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="companyName">Insurance Company *</label>
          <input type="text" id="companyName" formControlName="companyName" class="form-control" [disabled]="loading">
          <div class="error-message" *ngIf="policyForm.get('companyName')?.invalid && policyForm.get('companyName')?.touched">
            Company name is required
          </div>
        </div>
        
        <div class="form-group">
          <label for="policyType">Policy Type *</label>
          <select id="policyType" formControlName="policyType" class="form-control" [disabled]="loading">
            <option value="">Select Policy Type</option>
            <option *ngFor="let type of insuranceTypes" [value]="type">{{ type }}</option>
          </select>
          <div class="error-message" *ngIf="policyForm.get('policyType')?.invalid && policyForm.get('policyType')?.touched">
            Policy type is required
          </div>
        </div>
        
        <div class="form-group">
          <label for="policyNumber">Policy Number</label>
          <input type="text" id="policyNumber" formControlName="policyNumber" class="form-control" [disabled]="loading">
        </div>
        
        <div class="form-group">
          <label for="expiryDate">Expiry Date</label>
          <input type="date" id="expiryDate" formControlName="expiryDate" class="form-control" [disabled]="loading">
        </div>
      </div>
      
      <div class="form-group full-width">
        <label for="policyNotes">Notes</label>
        <textarea id="policyNotes" formControlName="notes" class="form-control" rows="3" placeholder="Additional policy notes..." [disabled]="loading"></textarea>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeAddPolicyModal()" [disabled]="loading">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="policyForm.invalid || loading">
          <i class="fas fa-spinner fa-spin" *ngIf="loading"></i>
          <i class="fas fa-shield-alt" *ngIf="!loading"></i>
          Add Policy
        </button>
      </div>
    </form>
  </div>
</div>

<!-- View Contact Modal -->
<div class="modal-overlay" *ngIf="showViewModal" (click)="closeViewModal()">
  <div class="modal-content view-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ selectedContact?.type === 'client' ? 'Client' : 'Prospect' }} Details</h2>
      <button class="btn-close" (click)="closeViewModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="contact-profile" *ngIf="selectedContact">
      <div class="profile-header">
        <div class="profile-avatar">
          <span>{{ selectedContact.firstName[0] }}{{ selectedContact.surname[0] || selectedContact.lastName[0] }}</span>
        </div>
        <div class="profile-info">
          <h3>{{ getDisplayName(selectedContact) }}</h3>
          <span class="status-badge large" [ngClass]="selectedContact.type">
            {{ selectedContact.type === 'client' ? 'Client' : 'Prospect' }}
          </span>
          <span class="has-policies-badge" *ngIf="selectedContact.hasExternalPolicies">
            <i class="fas fa-shield-alt"></i> Has External Policies
          </span>
        </div>
      </div>
      
      <div class="profile-details">
        <div class="detail-section">
          <h4>Contact Information</h4>
          <div class="detail-grid">
            <div class="detail-item" *ngIf="selectedContact.phoneNumber">
              <label>Phone:</label>
              <span>{{ selectedContact.phoneNumber }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedContact.email">
              <label>Email:</label>
              <span>{{ selectedContact.email }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedContact.address">
              <label>Address:</label>
              <span>{{ selectedContact.address }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedContact.nationalId">
              <label>National ID:</label>
              <span>{{ selectedContact.nationalId }}</span>
            </div>
          </div>
        </div>
        
        <div class="detail-section" *ngIf="selectedContact.type === 'client'">
          <h4>Personal Information</h4>
          <div class="detail-grid">
            <div class="detail-item" *ngIf="selectedContact.dateOfBirth">
              <label>Date of Birth:</label>
              <span>{{ formatDate(selectedContact.dateOfBirth) }}</span>
            </div>
            <div class="detail-item" *ngIf="selectedContact.dateOfBirth">
              <label>Age:</label>
              <span>{{ calculateAge(selectedContact.dateOfBirth) }} years</span>
            </div>
            <div class="detail-item" *ngIf="selectedContact.insuranceType">
              <label>Insurance Type:</label>
              <span>{{ selectedContact.insuranceType }}</span>
            </div>
          </div>
        </div>
        
        <div class="detail-section" *ngIf="selectedContact.policies && selectedContact.policies.length > 0">
          <h4>External Policies</h4>
          <div class="policies-list">
            <div class="policy-card" *ngFor="let policy of selectedContact.policies">
              <div class="policy-header">
                <h5>{{ policy.companyName }}</h5>
                <span class="policy-status" [ngClass]="policy.status.toLowerCase()">
                  {{ policy.status }}
                </span>
              </div>
              <div class="policy-details">
                <div class="policy-item" *ngIf="policy.type">
                  <label>Type:</label>
                  <span>{{ policy.type }}</span>
                </div>
                <div class="policy-item" *ngIf="policy.name">
                  <label>Policy Number:</label>
                  <span>{{ policy.name }}</span>
                </div>
                <div class="policy-item" *ngIf="policy.expiryDate">
                  <label>Expiry Date:</label>
                  <span>{{ formatDate(policy.expiryDate) }}</span>
                </div>
                <div class="policy-item" *ngIf="policy.notes">
                  <label>Notes:</label>
                  <span>{{ policy.notes }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="detail-section" *ngIf="selectedContact.notes">
          <h4>Notes</h4>
          <p class="notes-content">{{ selectedContact.notes }}</p>
        </div>
      </div>
      
      <div class="profile-actions">
        <button class="btn btn-secondary" (click)="openEditModal(selectedContact!)">
          <i class="fas fa-edit"></i>
          Edit {{ selectedContact?.type === 'client' ? 'Client' : 'Prospect' }}
        </button>
        <button class="btn btn-outline" 
                *ngIf="selectedContact?.type === 'prospect'" 
                (click)="convertProspectToClient(selectedContact!)">
          <i class="fas fa-user-check"></i>
          Convert to Client
        </button>
        <button class="btn btn-outline" 
                *ngIf="selectedContact?.type === 'prospect'" 
                (click)="openAddPolicyModal(selectedContact!)">
          <i class="fas fa-shield-alt"></i>
          Add Policy
        </button>
      </div>
    </div>
  </div>
</div>